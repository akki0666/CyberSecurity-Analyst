
# Malware Analysis and Reverse Engineering: Static vs. Dynamic Analysis

This guide provides a detailed, practical scenario and deep dive into **Malware Analysis** and **Reverse Engineering**, focusing on **Static Analysis** and **Dynamic Analysis**. Each method has its own use case, and we'll explore their application in real-world scenarios to analyze malicious software.

---

## Overview: Malware Analysis and Reverse Engineering

Malware analysis is the process of studying malicious software to understand its behavior, intent, and potential impact. Reverse engineering helps in breaking down the internal workings of the malware. The two major analysis techniques include:

1. **Static Analysis**: Involves analyzing malware without executing it, focusing on the file structure, code, and embedded resources.
2. **Dynamic Analysis**: Involves executing malware in a controlled environment to observe real-time behavior, such as network activity, system changes, and payload deployment.

---

## 1. Static Analysis

### Practical Scenario: Analyzing a Suspicious EXE File

A SOC team receives a suspicious email attachment (an executable file). The team begins with **static analysis** to understand the file's properties without executing it to avoid system compromise.

---

### Step-by-Step: Static Analysis

1. **File Identification and Metadata Analysis**:
   - **Tool**: Use **PEiD** or **Die (Detect It Easy)** to examine the file's structure and determine if it is packed or obfuscated.
   - **Objective**: Identify if the file is a PE executable, script, or if it's packed to hide its content.
   - **Example**: The tool detects that the EXE is packed with UPX, a common packing method used by malware to compress or hide the executable’s real content.

2. **String Extraction**:
   - **Tool**: Use the **Strings** utility to extract ASCII or Unicode strings from the binary.
   - **Objective**: Look for useful information such as URLs, IP addresses, system commands, or file paths.
   - **Example**: The string extraction shows URLs like `http://malicious-site.com` and suspicious commands like `rundll32.exe`, indicating possible remote communication or execution of additional payloads.

3. **Disassembly**:
   - **Tool**: Use **IDA Pro** or **Ghidra** to disassemble the binary and view the malware code.
   - **Objective**: Analyze the program flow and critical functions such as system commands, process execution, or network calls.
   - **Example**: The disassembly reveals function calls like `WinExec()` or `CreateProcess()`, suggesting that the malware launches external processes.

4. **Function/API Call Analysis**:
   - **Tool**: Use **Dependency Walker** or **PEview** to identify API functions the malware imports.
   - **Objective**: Understand the malware's capabilities by analyzing its function imports, especially those related to network communication or system modification.
   - **Example**: The malware imports `InternetOpen` and `HttpSendRequest`, indicating that it might perform web-based communication with a command-and-control server.

5. **Packed Malware Analysis**:
   - **Tool**: Use **UPX** to unpack the executable.
   - **Objective**: If the malware is packed, unpack it to reveal the original code and continue static analysis.
   - **Example**: Unpacking reveals additional code that includes obfuscated commands for executing further payloads.

---

### Deep Dive into Static Analysis Concepts

- **File Structure**: Understanding the Portable Executable (PE) structure is crucial. Malware often manipulates headers, sections, and entry points to evade detection.
- **Disassembly**: By examining assembly code, analysts can gain insight into what the malware will do, even without execution.
- **Static Analysis Challenges**: Malware authors frequently obfuscate or encrypt their payloads, making static analysis challenging and often necessitating dynamic analysis.

---

## 2. Dynamic Analysis

### Practical Scenario: Executing Malware in a Sandbox

When static analysis doesn’t provide enough details or the malware is heavily obfuscated, **dynamic analysis** is used. In this scenario, the SOC team runs the malware in a sandbox environment to observe its behavior in real-time.

---

### Step-by-Step: Dynamic Analysis

1. **Set Up a Sandbox Environment**:
   - **Tool**: Use **Cuckoo Sandbox**, **Any.Run**, or a virtual machine with **VMware Workstation** for isolated malware execution.
   - **Objective**: Safely run the malware in an environment where it can be fully observed.
   - **Example**: The malware is executed in a sandbox, and system changes are monitored while ensuring no infection spreads to the main network.

2. **Process Behavior Monitoring**:
   - **Tool**: Use **Process Monitor (ProcMon)** or **Process Explorer** to track processes spawned by the malware.
   - **Objective**: Analyze how the malware interacts with system files and registry keys.
   - **Example**: The malware spawns a process that modifies registry keys and creates a hidden file in the Temp directory, indicating persistence.

3. **Network Traffic Monitoring**:
   - **Tool**: Use **Wireshark** or **Fiddler** to capture network traffic.
   - **Objective**: Observe any network communication initiated by the malware, such as connections to command-and-control (C2) servers.
   - **Example**: The malware sends a POST request to `http://malicious-server.com` over port 80, suggesting C2 communication.

4. **File and Registry Changes**:
   - **Tool**: Use **Regshot** to compare system states before and after malware execution.
   - **Objective**: Detect file creation, registry modifications, and other persistence techniques.
   - **Example**: The malware adds a key to `HKCU\Software\Microsoft\Windows\CurrentVersion\Run` to start itself automatically upon system reboot.

5. **Memory Analysis**:
   - **Tool**: Use **Volatility** to capture and analyze the system's memory during malware execution.
   - **Objective**: Retrieve hidden data or unpack the malware that may be encrypted or obfuscated on disk but decrypted in memory.
   - **Example**: Memory analysis reveals additional payloads loaded by the malware during execution.

---

### Deep Dive into Dynamic Analysis Concepts

- **Behavioral Analysis**: Dynamic analysis focuses on system behavior during execution, such as file modifications, network communication, and process injection.
- **Evasion Techniques**: Advanced malware may detect sandbox environments or virtual machines and alter its behavior to avoid detection.
- **Memory Forensics**: Analyzing the system memory helps in uncovering hidden or obfuscated malware components that are difficult to analyze statically.

---

## Additional Practical Scenario 1: Analyzing a Ransomware Sample

### Scenario:
A company is hit by a ransomware attack. The SOC team uses dynamic analysis to understand the ransomware’s encryption behavior and communication channels.

### Workflow:

1. **Execution in Sandbox**:
   - The ransomware is executed in an isolated sandbox environment to safely observe its behavior.
   
2. **Process and File Monitoring**:
   - **Process Monitor** detects that the ransomware encrypts files across multiple directories, appending a `.locked` extension.
   
3. **Network Traffic Analysis**:
   - **Wireshark** captures outbound traffic to a remote IP, indicating communication with a command-and-control server to retrieve the encryption key.
   
4. **Memory Dump Analysis**:
   - **Volatility** captures memory snapshots, revealing the encryption key in memory before it’s transmitted to the attacker’s server.
   
5. **Response**:
   - The SOC team quarantines the infected systems and attempts to retrieve encryption keys from memory to decrypt the affected files.

---

## Additional Practical Scenario 2: Analyzing Polymorphic Malware

### Scenario:
A SOC analyst is tasked with analyzing a piece of polymorphic malware that constantly changes its code to evade detection.

### Workflow:

1. **Static Analysis**:
   - Initial static analysis shows heavily obfuscated code with randomized strings, making it difficult to understand.
   
2. **Dynamic Analysis**:
   - In a sandbox environment, the malware dynamically decrypts itself into memory, and the real payload is observed executing malicious activities.
   
3. **Process Monitoring**:
   - **Process Explorer** reveals that the malware injects itself into legitimate processes, like `explorer.exe`, to remain hidden.
   
4. **Memory Analysis**:
   - **Volatility** is used to capture the decrypted version of the malware from memory, which can then be analyzed in IDA Pro for further reverse engineering.

---

## Conclusion: Static vs. Dynamic Analysis

### **Static Analysis**:
- Focuses on disassembling and analyzing the malware without execution.
- Ideal for understanding the structure of the malware and its intended behavior.
- Limited by obfuscation and encryption techniques used by attackers.

### **Dynamic Analysis**:
- Involves executing the malware to observe real-time behavior.
- Useful for detecting actual payloads, system changes, and network activity.
- Effective for analyzing packed or polymorphic malware that is difficult to analyze statically.

**Both static and dynamic analysis** are essential techniques in malware analysis and reverse engineering. They complement each other, providing insights into the malware’s behavior, intent, and capabilities.

